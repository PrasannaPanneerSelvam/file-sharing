<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Transfer</title>
    <style>
        #progressBar {
            width: 80%;
            height: 30px;
            background-color: #f3f3f3;
            border: 1px solid #ccc;
        }

        #progressBar div {
            height: 100%;
            width: 0;
            background-color: #4caf50;
        }
    </style>
</head>

<body>
    <h1>Send File Over Local Network</h1>
    <h2 id="socketStatus">Yet to be connected!</h2>

    <input type="file" id="fileInput" />
    <button id="sendBtn">Send File</button>
    <div id="progressBar">
        <div></div>
    </div>
    <p id="status"></p>

    <script>
        const socketStatus = document.getElementById('socketStatus');
        const statusText = document.getElementById('status');

        const sendBtn = document.getElementById('sendBtn');
        const fileInput = document.getElementById('fileInput');

        const serverUrl = 'ws://172.20.10.6:3000'; // Change to your server's IP if needed
        const ws = new WebSocket(serverUrl);

        // Open WebSocket connection
        ws.onopen = () => {
            console.log('WebSocket connection established.');
            socketStatus.innerText = "Connection successful!";
        };

        // Send the file data when the button is clicked
        // sendBtn.addEventListener('click', () => {
        //     const file = fileInput.files[0];
        //     if (!file) {
        //         alert('Please select a file first');
        //         return;
        //     }

        //     ws.send(file.name);

        //     const reader = new FileReader();
        //     reader.onload = () => {
        //         const data = reader.result;
        //         // Send file data over WebSocket connection
        //         ws.send(data);
        //         console.log('File sent');
        //     };
        //     reader.readAsArrayBuffer(file);
        // });

        sendBtn.addEventListener('click', () => {
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select a file first');
                return;
            }

            // Validate file size (max 50MB)
            const maxSize = 5000 * 1024 * 1024; // 50MB
            if (file.size > maxSize) {
                alert('File is too large. Maximum size allowed is 50MB.');
                return;
            }

            // First, send the file name to the server
            ws.send(file.name);

            const chunkSize = 1024 * 1024; // 1MB chunks
            let offset = 0;

            const reader = new FileReader();
            reader.onload = function (e) {
                const chunk = e.target.result;
                ws.send(chunk); // Send the chunk to the server
                offset += chunkSize;

                // Update progress bar
                const progress = Math.round((offset / file.size) * 100);
                progressBar.style.width = `${progress}%`;
                statusText.textContent = `Uploading: ${progress}%`;

                if (offset < file.size) {
                    readNextChunk();
                } else {
                    console.log('File sent successfully!');
                    statusText.textContent = 'File transfer complete!';
                }
            };

            // Function to read the next chunk
            function readNextChunk() {
                const slice = file.slice(offset, offset + chunkSize);
                reader.readAsArrayBuffer(slice);
            }

            // Start reading and sending the first chunk
            readNextChunk();
        });
    </script>
</body>

</html>